<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allied Dash | Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background: #050505; color: white; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .input-field { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 0.75rem; width: 100%; outline: none; transition: border 0.2s; color: white; }
        .input-field:focus { border-color: #6366f1; }
        .nav-item.active { background: rgba(99, 102, 241, 0.1); color: #818cf8; border-color: rgba(99, 102, 241, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex">

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-[#050505] border-r border-white/5 flex flex-col justify-between p-6">
        <div class="space-y-8">
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-600/30 text-white">
                    <i class="fa-solid fa-bolt-lightning text-xs"></i>
                </div>
                <span class="font-bold italic tracking-tighter text-xl uppercase tracking-widest">Allied Dash</span>
            </div>
            <nav class="space-y-1">
                <label class="px-4 text-[10px] uppercase font-black text-zinc-600 tracking-[0.2em] mb-4 block">Database</label>
                <div id="tableNav" class="space-y-1"></div>
            </nav>
        </div>
        <div class="pt-6 border-t border-white/5">
            <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-500 hover:text-red-400 hover:bg-red-400/5 transition-all font-bold text-xs uppercase tracking-widest">
                <i class="fa-solid fa-right-from-bracket"></i> Logout Session
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col ml-72 min-h-screen">
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-10 sticky top-0 bg-[#050505]/80 backdrop-blur-md z-40">
            <h2 id="breadcrumb" class="text-[10px] font-black uppercase tracking-[0.2em] text-zinc-500">Nexus / Loading</h2>
            <div class="text-[10px] font-bold uppercase text-emerald-500 flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> Live
            </div>
        </header>

        <main class="p-10 flex-1">
            <header class="flex justify-between items-end mb-10">
                <div>
                    <h1 id="currentTableTitle" class="text-4xl font-black italic uppercase tracking-tighter">Table View</h1>
                    <p id="tableCount" class="text-zinc-500 text-sm mt-1 font-medium italic">Fetching...</p>
                </div>
                <button onclick="openPanel('add')" class="bg-white text-black hover:bg-indigo-500 hover:text-white px-6 py-3 rounded-xl font-bold text-xs uppercase tracking-widest transition-all">
                    <i class="fa-solid fa-plus mr-2"></i> Add Record
                </button>
            </header>

            <div id="dataGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-zinc-700">
                <p class="uppercase text-[10px] font-black tracking-widest">No entries found</p>
            </div>
        </main>
    </div>

    <div id="sidePanel" class="fixed inset-y-0 right-0 w-full max-w-md glass translate-x-full transition-transform duration-500 z-[100] p-8">
        <div class="flex justify-between items-center mb-10">
            <h2 id="panelTitle" class="text-2xl font-black italic uppercase">Manage</h2>
            <button onclick="closePanel()" class="text-zinc-500 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
        </div>
        <form id="recordForm" class="space-y-6">
            <input type="hidden" id="recordId">
            <div id="dynamicInputs" class="space-y-6"></div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black uppercase tracking-widest hover:bg-indigo-500 transition-all">Commit Changes</button>
        </form>
    </div>

    <script>
        const SUPABASE_URL = "https://eyxhddkoqotedgucpfbz.supabase.co";
        const SUPABASE_KEY = "sb_publishable_h4nlL7bfvrg-amPOoqyhTw_CJjsVfJc"; 
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const TABLES_CONFIG = [
            { id: 'members', name: 'Members', icon: 'fa-users', fields: ['name', 'role', 'des', 'img'] },
            { id: 'sponsors', name: 'Sponsors', icon: 'fa-handshake', fields: ['name', 'logo_url', 'website_url'] },
            { id: 'robot_designs', name: 'Robot Designs', icon: 'fa-robot', fields: ['heading', 'download_path', 'cad_link'] },
            { id: 'seasons', name: 'Seasons', icon: 'fa-calendar-days', fields: ['year', 'title', 'description'] },
            { id: 'outreach', name: 'People Outreached', icon: 'fa-chart-pie', fields: ['platform', 'count'] }
        ];

        let currentTable = TABLES_CONFIG[0];
        let outreachChart = null;

        async function checkAuth() {
            const { data: { session } } = await sb.auth.getSession();
            if (!session) window.location.replace('login.html');
            else initDash();
        }

        function initDash() {
            renderSidebar();
            switchTable(currentTable.id);
        }

        function renderSidebar() {
            const nav = document.getElementById('tableNav');
            nav.innerHTML = TABLES_CONFIG.map(t => `
                <button onclick="switchTable('${t.id}')" class="nav-item w-full text-left px-4 py-3 rounded-xl border border-transparent transition-all flex items-center gap-3 text-xs font-bold uppercase tracking-widest ${currentTable.id === t.id ? 'active' : 'text-zinc-500 hover:text-white'}">
                    <i class="fa-solid ${t.icon} w-4 text-center"></i> ${t.name}
                </button>
            `).join('');
        }

        async function switchTable(id) {
            currentTable = TABLES_CONFIG.find(t => t.id === id);
            document.getElementById('currentTableTitle').innerText = currentTable.name;
            document.getElementById('breadcrumb').innerText = `Nexus / ${currentTable.name}`;
            renderSidebar();
            await fetchData();
        }

        async function fetchData() {
            const grid = document.getElementById('dataGrid');
            grid.innerHTML = '<div class="col-span-full py-10 text-center animate-pulse uppercase text-[10px] font-black text-zinc-600">Syncing...</div>';
            const { data, error } = await sb.from(currentTable.id).select('*');
            if(error) { grid.innerHTML = `<p class="text-red-500">${error.message}</p>`; return; }
            document.getElementById('tableCount').innerText = `${data.length} Records`;
            if (data.length === 0) { grid.innerHTML = ""; document.getElementById('emptyState').classList.remove('hidden'); }
            else { document.getElementById('emptyState').classList.add('hidden'); if (currentTable.id === 'outreach') renderAnalytics(data); else renderCards(data); }
        }

        function renderCards(items) {
            const grid = document.getElementById('dataGrid');
            grid.innerHTML = items.map(item => `
                <div class="glass p-6 rounded-[2rem] hover:border-indigo-500/50 transition-all group">
                    <div class="flex justify-between mb-6">
                        <div class="w-10 h-10 bg-white/5 rounded-xl flex items-center justify-center text-zinc-400 group-hover:text-indigo-400"><i class="fa-solid ${currentTable.icon}"></i></div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                            <button onclick='openPanel("edit", ${JSON.stringify(item)})' class="w-8 h-8 rounded-lg bg-white/5 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-pen text-[10px]"></i></button>
                            <button onclick="deleteRecord('${item.id}')" class="w-8 h-8 rounded-lg bg-white/5 text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                    </div>
                    ${currentTable.fields.map(f => `<div class="mb-4"><label class="text-[8px] uppercase text-zinc-600 font-black block mb-0.5 tracking-widest">${f.replace('_',' ')}</label><p class="text-sm font-bold text-white truncate">${item[f] || 'â€”'}</p></div>`).join('')}
                </div>`).join('');
        }

        function renderAnalytics(items) {
            const grid = document.getElementById('dataGrid');
            const stats = { youtube: 0, facebook: 0, instagram: 0, cad: 0, website: 0 };
            items.forEach(i => {
                const p = i.platform.toLowerCase();
                const c = Number(i.count) || 0;
                if(p.includes('yt') || p.includes('you')) stats.youtube += c;
                else if(p.includes('fb') || p.includes('face')) stats.facebook += c;
                else if(p.includes('insta')) stats.instagram += c;
                else if(p.includes('cad')) stats.cad += c;
                else stats.website += c;
            });

            grid.innerHTML = `
                <div class="col-span-full grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    ${Object.entries(stats).map(([k, v]) => `<div class="glass p-6 rounded-3xl text-center border-white/5"><p class="text-[10px] font-black uppercase text-zinc-600 mb-1 tracking-widest">${k}</p><p class="text-2xl font-black italic text-indigo-400">${v.toLocaleString()}</p></div>`).join('')}
                </div>
                <div class="col-span-full lg:col-span-1 glass p-10 rounded-[3rem] flex items-center justify-center"><div style="width: 100%; max-width: 300px;"><canvas id="outreachChart"></canvas></div></div>
                <div class="col-span-full lg:col-span-2 space-y-3">
                    <label class="text-[10px] font-black uppercase text-zinc-600 tracking-[0.2em] mb-4 block px-4">Manage Records</label>
                    <div class="max-h-[400px] overflow-y-auto pr-2 space-y-3 custom-scrollbar">
                        ${items.map(item => `
                            <div class="glass p-4 rounded-2xl flex justify-between items-center border-white/5 hover:border-indigo-500/30 transition-all">
                                <div><p class="text-xs font-bold text-white uppercase">${item.platform}</p><p class="text-[10px] font-medium text-zinc-500">${Number(item.count).toLocaleString()} Reached</p></div>
                                <div class="flex gap-2">
                                    <button onclick='openPanel("edit", ${JSON.stringify(item)})' class="w-8 h-8 rounded-lg bg-white/5 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-pen text-[10px]"></i></button>
                                    <button onclick="deleteRecord('${item.id}')" class="w-8 h-8 rounded-lg bg-white/5 text-red-500 flex items-center justify-center"><i class="fa-solid fa-trash text-[10px]"></i></button>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>`;

            if (outreachChart) outreachChart.destroy();
            outreachChart = new Chart(document.getElementById('outreachChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: Object.keys(stats).map(s => s.toUpperCase()),
                    datasets: [{ data: Object.values(stats), backgroundColor: ['#6366f1', '#a855f7', '#ec4899', '#f43f5e', '#10b981'], borderWidth: 0 }]
                },
                options: { plugins: { legend: { position: 'bottom', labels: { color: '#71717a', font: { weight: 'bold', size: 10 }, padding: 20 } } }, maintainAspectRatio: false }
            });
        }

        function openPanel(mode, data = null) {
            document.getElementById('sidePanel').classList.remove('translate-x-full');
            document.getElementById('panelTitle').innerText = mode === 'edit' ? 'Update Entry' : 'Create Entry';
            document.getElementById('dynamicInputs').innerHTML = currentTable.fields.map(f => `
                <div class="space-y-2">
                    <label class="text-[10px] uppercase font-black text-zinc-500 tracking-widest">${f.replace('_',' ')}</label>
                    <input type="text" id="field_${f}" class="input-field" value="${data ? (data[f] || '') : ''}">
                </div>`).join('');
            document.getElementById('recordId').value = data ? data.id : "";
        }

        function closePanel() { document.getElementById('sidePanel').classList.add('translate-x-full'); }

        document.getElementById('recordForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('recordId').value;
            const payload = {};
            currentTable.fields.forEach(f => {
                let val = document.getElementById(`field_${f}`).value;
                payload[f] = (f === 'count' || f.includes('impacted') || f.includes('spent')) ? (parseInt(val) || 0) : val;
            });
            const { error } = id ? await sb.from(currentTable.id).update(payload).eq('id', id) : await sb.from(currentTable.id).insert([payload]);
            if (error) alert(error.message); else { closePanel(); fetchData(); }
        };

        async function deleteRecord(id) { if(confirm("Confirm deletion?")) { await sb.from(currentTable.id).delete().eq('id', id); fetchData(); } }
        async function logout() { await sb.auth.signOut(); window.localStorage.clear(); window.location.replace('login.html'); }
        checkAuth();
    </script>
</body>
</html>
